# 量化交易系统设计方案

## 一、系统架构总览

### 架构层次：

本系统采用 “**核心模块进程内模块化集成 + 支撑功能微服务化 + 可插拔实现**” 的混合架构，平衡低延迟交易需求与系统扩展性。整体分为三层：

- **核心交易层**：进程内模块化设计，处理实时交易链路（微秒级响应）
- **支撑服务层**：独立部署的微服务，提供非实时性支撑功能
- **接入层**：负责外部系统对接与用户交互



### 核心设计原则：

- **低延迟优化**：核心交易链路全程内存交互，无网络开销，平均延迟 < 100 微秒
- **高可用性**：核心模块多实例部署，微服务集群化，关键组件主备切换
- **可扩展性**：通过插件机制扩展数据源 / 策略 / 执行渠道，无需修改核心代码
- **安全性**：多层风控（事前 / 事中 / 事后），操作审计，数据加密传输
- **可维护性**：模块化边界清晰，微服务独立升级，插件化降低耦合



## 二、核心交易层（进程内模块）

所有模块运行在同一进程内，通过内存级事件总线通信，避免跨进程延迟。

| 模块名称             | 核心功能                                                | 可插拔设计                                                   |
| -------------------- | ------------------------------------------------------- | ------------------------------------------------------------ |
| 事件总线模块         | 系统事件中枢，负责模块间消息传递                        | 无（核心基础设施），支持事件类型扩展                         |
| 行情处理模块         | 接收、清洗、标准化行情数据并分发                        | 定义`IDataSource`抽象接口（连接 / 断开 / 订阅 / 取消订阅） - 具体数据源（如 CTP、Binance）通过插件实现 - 数据源管理器动态加载 / 切换插件 - 支持多数据源并行接入与数据融合 |
| 策略引擎模块         | 加载、运行、管理量化策略，生成交易信号                  | 定义`StrategyBase`抽象基类（初始化 / 启动 / 停止 / 行情处理 / 订单回调） - 具体策略（如趋势跟踪、套利）通过继承基类实现，编译为插件 - 策略工厂基于配置动态加载策略插件 - 支持策略热加载 / 卸载 |
| 订单管理模块（OMS）  | 订单全生命周期管理（创建 / 修改 / 取消 / 状态跟踪）     | 无（核心流程固定），但支持订单类型扩展（限价单 / 市价单 / 条件单） |
| 执行管理模块（EMS）  | 将订单发送至交易所，处理执行回报                        | 定义`IExecutionAdapter`抽象接口（发单 / 撤单 / 订单查询） - 针对不同交易所（如上期所、CME）实现适配器插件 - 执行路由根据品种自动选择适配插件 - 支持插件故障自动切换 |
| 账户持仓模块         | 实时跟踪资金、持仓、盈亏状态                            | 无（逻辑固定），支持多账户隔离管理                           |
| 风险控制模块（实时） | 订单发送前 / 执行中的风险检查（资金、持仓、频率限制等） | 风险规则可配置，支持自定义风险指标插件                       |



## 三、支撑服务层（独立微服务）

通过 RPC（gRPC）或消息队列与核心交易层通信，容忍毫秒级延迟。

| 微服务名称   | 核心功能                                                     | 技术特性                                                     |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 配置中心服务 | 集中管理系统配置（数据源参数、策略参数、风控阈值等）         | 支持动态配置更新，配置版本管理，权限控制                     |
| 历史数据服务 | 存储 / 查询历史行情、成交记录、策略回测数据                  | 基于时序数据库（如 ClickHouse），支持高效批量查询，数据自动归档 |
| 日志分析服务 | 收集 / 存储 / 检索系统日志与交易流水                         | 支持日志分级、按模块过滤，提供全文检索，日志可视化分析       |
| 监控告警服务 | 监控系统指标（CPU / 内存 / 延迟）与业务指标（策略收益 / 订单量） | 实时指标采集，自定义告警阈值，多渠道通知（邮件 / 短信 / 钉钉） |
| 回测引擎服务 | 基于历史数据验证策略有效性                                   | 支持多线程并行回测，模拟滑点 / 手续费，生成绩效报告（夏普比率 / 最大回撤） |
| 策略研发服务 | 策略代码管理、编译、测试                                     | 集成 Git 版本控制，自动化编译插件，策略安全审计              |
| 风控审计服务 | 事后风险分析与合规审计                                       | 生成每日 / 每月风控报告，检查是否符合监管要求，异常交易行为分析 |



## 四、接入层

| 组件名称         | 功能说明                                                 | 部署方式                                        |
| ---------------- | -------------------------------------------------------- | ----------------------------------------------- |
| 前端控制台       | 可视化操作界面（策略启停、参数调整、订单监控、绩效展示） | Web 应用（独立部署，通过 API 网关与后端通信）   |
| API 网关         | 统一接口入口，处理认证、限流、请求路由                   | 独立部署，作为微服务与前端 / 外部系统的交互中枢 |
| 第三方系统适配器 | 对接外部系统（如资管平台、清算系统）                     | 独立部署，按需扩展适配器类型                    |



## 五、可插拔设计详细说明

### 1. 行情数据源可插拔设计

- **抽象接口层**：定义`IDataSource`标准接口，包含：
  - 连接管理：`connect(config)`、`disconnect()`
  - 订阅控制：`subscribe(instruments)`、`unsubscribe(instruments)`
  - 数据回调：`on_tick(tick_data)`、`on_bar(bar_data)`
  - 状态查询：`is_connected()`、`get_supported_instruments()`
- **插件实现层**：
  - 每种数据源（如 CTP、Binance、Wind）实现`IDataSource`接口
  - 编译为独立动态库（.so/.dll），包含插件元数据（支持的品种、数据类型）
  - 实现数据协议解析与转换（统一为系统内部格式）
- **管理组件**：
  - 数据源管理器：负责插件加载、配置解析、生命周期管理
  - 数据融合器：多数据源时按优先级合并数据（如主备数据源切换）
  - 插件注册中心：维护可用数据源插件列表与版本信息

### 2. 策略实现可插拔设计

- **抽象基类层**：定义`StrategyBase`基类，包含：
  - 生命周期方法：`init(config)`、`start()`、`pause()`、`resume()`、`stop()`
  - 事件处理方法：`on_tick(tick)`、`on_bar(bar)`、`on_order(order)`、`on_trade(trade)`
  - 交互方法：`send_signal(signal)`、`get_parameter(key)`、`set_parameter(key, value)`
- **策略实现层**：
  - 具体策略继承`StrategyBase`，实现业务逻辑
  - 编译为策略插件（.so/.dll），包含策略元数据（名称、作者、参数描述）
  - 支持自定义指标计算与信号生成逻辑
- **管理组件**：
  - 策略工厂：根据配置动态加载策略插件，创建实例
  - 策略调度器：管理多策略并行运行，隔离资源
  - 策略仓库：存储策略插件，支持版本管理与灰度发布

### 3. 下单执行模块可插拔设计

- **抽象接口层**：定义`IExecutionAdapter`接口，包含：

  - 连接管理：`connect(config)`、`disconnect()`
  - 订单操作：`send_order(order)`、`cancel_order(order_id)`、`modify_order(order)`
  - 查询功能：`query_orders(filters)`、`query_trades(filters)`
  - 回报回调：`on_order_status(order)`、`on_trade(trade)`

- **适配器实现层**：

  - 每个交易所 / 经纪商对应一个适配器（如 CTPAdapter、IBAdapter）
  - 实现交易所协议转换（系统内部订单格式→交易所协议格式）
  - 处理交易所回报解析与转换

- **管理组件**：

  - 执行适配器管理器：加载 / 切换适配器插件，监控连接状态
  - 订单路由：根据品种、流动性、成本选择最优执行适配器
  - 故障恢复：适配器异常时自动切换备用插件，重发未完成订单

  

## 六、模块与微服务交互方式

- **核心模块内部**：通过内存事件总线（无锁队列）传递事件，同步 / 异步处理
- **核心层→微服务**：通过 gRPC 同步调用（如查询历史数据）或消息队列异步通知（如写入日志）
- **微服务→核心层**：通过消息队列推送事件（如配置更新），核心层监听指定主题
- **微服务之间**：通过 gRPC 或消息队列交互（如回测服务调用历史数据服务）



此设计既满足了量化交易对低延迟的核心需求，又通过微服务和插件化架构实现了系统的灵活性与可扩展性，可适应从低频套利到中高频交易的多种场景。